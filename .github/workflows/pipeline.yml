name: EcomStore Continuous Delivery

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø£Ù…Ø§Ù†
permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ

    steps:
      # 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù€ Git History
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Honeycomb Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØªØ§Ø­
      - name: Setup Honeycomb Observability
        uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: ecom-store-production
        continue-on-error: true # Ù„ÙƒÙŠ Ù„Ø§ ÙŠØªÙˆÙ‚Ù Ø§Ù„Ù€ Pipeline Ø¥Ø°Ø§ ÙØ´Ù„ Honeycomb

      # 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø®Ø²Ù† ØµÙˆØ± GitHub (GHCR)
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Docker Buildx (Ø£Ø³Ø±Ø¹ ÙˆÙŠØ¯Ø¹Ù… Ø§Ù„Ù€ Cache)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Images
        uses: docker/bake-action@v4
        with:
          files: docker-stack-Swarm.yml
          push: true
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max

      # 5. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø®Ø§Ù† (Smoke Test) Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
      - name: Production Smoke Test
        run: |
          echo "Starting containers for validation..."
          docker compose -f docker-stack-Swarm.yml up -d

          echo "Waiting for SQL Server and Services to warm up..."
          sleep 45 

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
          docker ps

          # Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯ØŒ Ø§Ù„ÙØ±ÙˆÙ†ØªØŒ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©) ØªØ¹Ù…Ù„ ÙˆÙ„ÙŠØ³Øª ÙÙŠ Ø­Ø§Ù„Ø© Crash
          RUNNING_COUNT=$(docker ps --filter "status=running" --format "{{.Names}}" | wc -l)
          if [ "$RUNNING_COUNT" -lt 3 ]; then
            echo "âŒ Critical Error: Some containers are not running!"
            docker compose -f docker-stack-Swarm.yml logs
            exit 1
          fi

      # 6. Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      - name: Deployment Success
        if: success()
        run: |
          echo "âœ… All checks passed!"
          echo "ğŸš€ Images are now live at ghcr.io/${{ github.repository_owner }}"
          echo "ğŸŒ Railway will automatically detect the new image tags and deploy."
