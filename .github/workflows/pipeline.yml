name: EcomStore Continuous Delivery

on:
  push:
    branches: [main] # Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø£ÙƒØ´Ù† ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ

permissions:
  contents: read
  packages: write # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø£ÙƒØ´Ù† Ø¨Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù€ GitHub Packages

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Honeycomb Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (Pipeline Observability)
      - name: Setup Honeycomb
        uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: ecom-store-production

      # 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù€ GitHub Container Registry (GHCR)
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ± (Backend & Frontend) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù€ Swarm
      - name: Build Images
        run: |
          docker compose -f docker-stack-Swarm.yml build

      # 5. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù€ GitHub Packages
      - name: Push Images to GHCR
        run: |
          docker compose -f docker-stack-Swarm.yml push

      # 6. Ø§Ø®ØªØ¨Ø§Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª (Smoke Test)
      - name: Smoke Test
        run: |
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØµØºØ±Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø§ØªÙ„Ø©
          docker compose -f docker-stack-Swarm.yml up -d
          sleep 30 # ÙˆÙ‚Øª Ø¥Ø¶Ø§ÙÙŠ Ù„Ù€ SQL Edge Ù„ØªØ¨Ø¯Ø£
          docker ps
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ØªØ¹Ù…Ù„ (Ù„ÙŠØ³Øª ÙÙŠ Ø­Ø§Ù„Ø© Restarting)
          if [ $(docker ps -f status=running | wc -l) -lt 3 ]; then 
            echo "âŒ Some containers failed to start!"; 
            exit 1; 
          fi

      # 7. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      - name: Success Notification
        if: success()
        run: echo "ğŸš€ Build and Test passed! Railway will now take over deployment."
